sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: oCxX3ALAfoRb0/PHxa0sZF8/96T23fiI0BAA6b1dFTQPK8xE3547D2GKHx6MdadCyra5oU9MWLzB4U8rH0VymPawkg8NGY7eFXc0NDukBm7bph1nureFHmyCXsFdam6cK8Y4k+AMViOxPV3PjBuy1ay6+AgjoSxKDVRnfzAFtts03JbGbr/WZmpsI2ANg2Oldb5v/WYvkCCpW+TfME3fIjdQlG1Nskx9XdWi+MxkUkhQROX/RNCV+WpYNtoDlagSBW3u78GHt5pds/Oci//vviV3lsmYbtSNecpdrf3b9PyJOToN6PJw/0kL4hbEVaQtoPffM5uEzqyXbxGVtl1fFbPgBaN6ehL6a7vuTvoYn+qVYtnsKbphILqToABBkR0+wc6MnmZLMQJchtQ23nB/JZn3t06QTfZwYVizTdsZg9Km42tjvjDX7hDBB8rFgW0FSvvAvKiXnNknBuGdrhiAR5+FrVH8EGYf070TZxrzjFtholbnu9aGaU7OM+Vg/jwqXQtSh7EGQvsWpn9LOPYgXomTGBTxj3MnKUl2v+Q3ri5sgxUb4Ypiz3H6XJz5afihpfcEj2eX6SgUycnKQiDw9ta69vEZc5tA1vTSnOZqAkqTfSW7pDSQ12gqgrQ1bN7SFVWC5N3fhexPvVFiRE+xhLjlWzu+fOcVLrn/2FEjSgQ=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/Studies-and-Essays--Quality-and-Others_2904
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy